using System.Collections;
using System.Collections.Generic;
using UnityEngine;

public class NpcFellow : MovingObject
{
    [Header("NPCの名前")] public string npcName;
    [Header("NPCの攻撃力")] public int npcAttack;
    [HideInInspector] public Vector2 npcBeforePosition;
    protected player playerObj;

    // Start is called before the first frame update
    protected override void Start()
    {
        base.Start();
        playerObj = GameObject.FindWithTag("Player").GetComponent<player>();
        setFirstPosition();
    }

    /**
     * NPCの行動
     */
    public void fellowAction(Vector2 frontCharPosition)
    {
        //移動
        if (playerObj.isMoving)
        {
            moveChar(frontCharPosition);
            return;
        }
        //攻撃
        if (playerObj.isAttack)
        {
            attack();
            return;
        }
    }

    /**
     * NPCを初期位置にセットする
     */
    protected void setFirstPosition()
    {
        if (GManager.instance.fellows.Count > 1)
        {
            transform.position = GManager.instance.fellows[GManager.instance.fellows.Count - 1].npcBeforePosition;
        }
        else
        {
            transform.position = playerObj.playerBeforePosition;
        }
    }

    /**
     * 攻撃処理
     */
    protected void attack()
    {
        //プレイヤーが敵を倒しているか、敵以外に対して攻撃した場合
        if (playerObj.enemyObject == null)
        {
            return;
        }
        if (animator != null)
        {
            animator.Play("NpcAttack");
        }
        int tempNpcAttack = npcAttack == 0 ?10:npcAttack;
        playerObj.enemyObject.enemyHp -= tempNpcAttack;
        GManager.instance.wrightAttackLog(npcName, playerObj.enemyObject.enemyName, tempNpcAttack);
    }

    /**
     * キャラクターの移動
     */
    protected override void moveChar(Vector2 end)
    {
        RaycastHit2D hit;
        boxCollider.enabled = false;
        hit = Physics2D.Linecast(transform.position, end, blockingLayer | treasureLayer);
        boxCollider.enabled = true;
        if (hit.transform != null)
        {
            return;
        }
        npcBeforePosition = transform.position;
        StartCoroutine(SmoothMovement(end));
    }
}
